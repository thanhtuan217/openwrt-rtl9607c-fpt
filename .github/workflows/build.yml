name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      ssh_to_image:
        description: 'Enable SSH on the final image'
        required: false
        default: 'false'
      custom_firmware_name:
        description: 'Custom firmware filename (e.g., my_router_fw.bin)'
        required: false
        default: ''

  push:
    branches:
      - master # Hoáº·c main, tÃ¹y vÃ o branch chÃ­nh cá»§a báº¡n
    paths:
      - '.config' # KÃ­ch hoáº¡t build khi file .config thay Ä‘á»•i
      - '.github/workflows/build.yml' # KÃ­ch hoáº¡t build khi build.yml thay Ä‘á»•i

env:
  TZ: Asia/Ho_Chi_Minh

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Your Repo (Láº¥y .config vÃ  workflow)
        uses: actions/checkout@v4

      - name: Checkout OpenWrt Source ðŸ’¡ FIX: Táº£i mÃ£ nguá»“n OpenWrt
        run: |
          # Clone mÃ£ nguá»“n OpenWrt chÃ­nh thá»©c vÃ o thÆ° má»¥c con 'openwrt'
          # Báº¡n cÃ³ thá»ƒ thay 'openwrt-23.05' báº±ng 'main' náº¿u muá»‘n báº£n má»›i nháº¥t.
          git clone -b openwrt-23.05 https://github.com/openwrt/openwrt.git openwrt

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential diffutils gawk gcc-multilib libelf-dev libncurses5-dev rsync unzip wget git python3 file

      - name: Load custom config
        run: |
          # Copy .config tá»« thÆ° má»¥c gá»‘c cá»§a repo vÃ o thÆ° má»¥c OpenWrt
          cp .config openwrt/.config

      - name: Download and update feeds ðŸ’¡ FIX: Cháº¡y trong thÆ° má»¥c OpenWrt
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Adjust .config for G97RG6W (Final safety checks)
        working-directory: ./openwrt
        run: |
          # XÃ³a má»i DEVICE_XXXX khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ cÃ³ G97RG6W Ä‘Æ°á»£c chá»n
          sed -i '/CONFIG_TARGET_realtek_rtl83xx_DEVICE_.\*=y/d' .config
          # ThÃªm láº¡i CONFIG_TARGET_realtek_rtl83xx_DEVICE_G97RG6W=y náº¿u chÆ°a cÃ³
          grep -q "CONFIG_TARGET_realtek_rtl83xx_DEVICE_G97RG6W=y" .config || echo "CONFIG_TARGET_realtek_rtl83xx_DEVICE_G97RG6W=y" >> .config
          
          # Äáº£m báº£o cÃ¡c gÃ³i Luci cÆ¡ báº£n Ä‘Æ°á»£c chá»n
          grep -q "CONFIG_PACKAGE_luci=y" .config || echo "CONFIG_PACKAGE_luci=y" >> .config
          grep -q "CONFIG_PACKAGE_luci-compat=y" .config || echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          grep -q "CONFIG_PACKAGE_luci-theme-bootstrap=y" .config || echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
          
          # Náº¿u muá»‘n báº­t SSH trong áº£nh cuá»‘i cÃ¹ng
          if [ "${{ github.event.inputs.ssh_to_image }}" == "true" ]; then
            sed -i 's/# CONFIG_PACKAGE_dropbear is not set/CONFIG_PACKAGE_dropbear=y/' .config
          fi

      - name: Build firmware
        working-directory: ./openwrt
        run: |
          make defconfig
          make -j$(nproc) V=s

      - name: Prepare Artifacts
        id: prepare_artifacts
        run: |
          # ÄÆ°á»ng dáº«n nÃ y giá» lÃ  tÆ°Æ¡ng Ä‘á»‘i tá»« thÆ° má»¥c gá»‘c cá»§a runner (nÆ¡i build báº¯t Ä‘áº§u)
          FIRMWARE_DIR="./openwrt/bin/targets/realtek/rtl83xx"
          ARTIFACT_NAME="OpenWrt-G97RG6W-Firmware"
          
          # Táº¡o tÃªn file custom náº¿u Ä‘Æ°á»£c cung cáº¥p tá»« input
          CUSTOM_NAME="${{ github.event.inputs.custom_firmware_name }}"
          if [ -n "$CUSTOM_NAME" ]; then
            ARTIFACT_NAME="$CUSTOM_NAME"
          fi
          
          # Logic tÃ¬m kiáº¿m file firmware (Giá»¯ nguyÃªn)
          FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -name "openwrt-*-g97rg6w-squashfs-factory.bin" -print -quit)
          
          if [ -z "$FIRMWARE_FILE" ]; then
            FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -name "openwrt-*-rtl9607c-squashfs-factory.bin" -print -quit)
          fi
          
          if [ -z "$FIRMWARE_FILE" ]; then
            FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -name "openwrt-*-rtl83xx-squashfs-factory.bin" -print -quit)
          fi
          
          if [ -z "$FIRMWARE_FILE" ]; then
            FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -name "openwrt-*-rtl838x-squashfs-factory.bin" -print -quit)
          fi
          
          if [ -z "$FIRMWARE_FILE" ]; then
            FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -name "*.squashfs-factory.bin" -print -quit)
          fi
          
          if [ -z "$FIRMWARE_FILE" ]; then
            echo "Error: Factory firmware file not found in $FIRMWARE_DIR"
            exit 1
          fi
          
          echo "Found firmware file: $FIRMWARE_FILE"
          echo "firmware_path=$FIRMWARE_FILE" >> $GITHUB_ENV
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV
          echo "firmware_name=$(basename $FIRMWARE_FILE)" >> $GITHUB_ENV

      - name: Upload firmware as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact_name }}
          path: ${{ env.firmware_path }}
          retention-days: 7
