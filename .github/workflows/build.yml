name: Build OpenWrt RTL9607C (Fix Path Error)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04 # Nên dùng 22.04 thay vì latest
    steps:
      - name: 1. Checkout Custom Repository
        # Bước này checkout toàn bộ repo của bạn vào thư mục GỐC
        uses: actions/checkout@v4

      - name: 2. Setup build environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget

      - name: 3. Clone OpenWrt Source
        run: |
          echo "Cloning OpenWrt source..."
          # Clone OpenWrt vào thư mục openwrt
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
          
          # Cần chạy feeds update/install SAU KHI copy custom files để tránh lỗi
          
      - name: 4. Copy Custom Target and .config
        # KHẮC PHỤC LỖI PATH: Copy nội dung từ thư mục gốc vào thư mục openwrt/
        run: |
          echo "Applying custom files (target/ và .config)..."
          
          # 1. Copy file .config quan trọng vào thư mục OpenWrt
          cp -f .config openwrt/.config
          
          # 2. KHẮC PHỤC LỖI: Copy NỘI DUNG thư mục target/ (chứa định nghĩa RTL9607C)
          # Dùng 'target/*' để copy nội dung đè lên openwrt/target/
          cp -rf target/* openwrt/target/
     
          # 3. KHẮC PHỤC LỖI: Copy NỘI DUNG thư mục package/ (nếu có)
          if [ -d "package" ]; then
            # Dùng 'package/*' để copy nội dung đè lên openwrt/package/
            cp -rf package/* openwrt/package/
            echo "✅ package/ also copied."
          fi
          
          echo "Finished applying custom files."

      - name: 5. Update Feeds và Thiết lập Cấu hình
        # Bước feeds và defconfig được chạy sau khi custom files đã có
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # Đảm bảo cấu hình chip G97RG6W được áp dụng
          make defconfig

      - name: 6. Build Firmware
        run: |
          cd openwrt
          # Tải source code cần thiết
          make download -j$(nproc)
          # Bắt đầu build
          make -j$(nproc) V=s
          
      - name: 7. Upload Artifacts (Firmware)
        # Tải file firmware đã build lên GitHub Actions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Firmware_RTL9607C
          path: openwrt/bin/targets/
