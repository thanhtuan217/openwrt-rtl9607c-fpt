name: Build OpenWrt RTL9607C (Fix Copy Error and Use 23.05 Stable)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout Custom Repository
        uses: actions/checkout@v4

      - name: 2. Setup build environment
        run: |
          sudo apt update
          # Thêm python3-setuptools để tăng ổn định
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils python3-setuptools rsync unzip zlib1g-dev file wget

      - name: 3. Clone OpenWrt Source (Sử dụng nhánh ổn định 23.05)
        run: |
          echo "Cloning OpenWrt source..."
          # Sử dụng nhánh ổn định openwrt-23.05 để tăng tương thích
          git clone --depth 1 -b openwrt-23.05 https://github.com/openwrt/openwrt.git openwrt

      - name: 4. Copy Custom Target and .config (Khắc phục triệt để lỗi Path)
        run: |
          # KIỂM TRA QUAN TRỌNG: Đảm bảo thư mục 'target' custom tồn tại
          if [ ! -d "target" ]; then
            echo "❌ LỖI NGHIÊM TRỌNG: Thư mục 'target' custom (chứa định nghĩa chip) không tồn tại trong thư mục gốc của repo này!"
            echo "Vui lòng đảm bảo cấu trúc thư mục của bạn có 'target/'."
            exit 1
          fi
          
          echo "Applying custom files (target/ và .config)..."
          
          # 1. Copy file .config
          cp -f .config openwrt/.config
          
          # 2. KHẮC PHỤC LỖI: Copy NỘI DUNG thư mục target/ (chứa định nghĩa RTL9607C)
          # Lệnh này đảm bảo copy nội dung an toàn nhất.
          cp -rf target/* openwrt/target/
     
          # 3. Copy NỘI DUNG thư mục package/ (nếu có)
          if [ -d "package" ]; then
            cp -rf package/* openwrt/package/
            echo "✅ package/ also copied."
          fi
          
          echo "Finished applying custom files."

      - name: 5. Update Feeds và Thiết lập Cấu hình
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # make defconfig phải chạy sau khi update feeds và copy .config
          make defconfig

      - name: 6. Build Firmware
        run: |
          cd openwrt
          # Tải source code cần thiết (luôn chạy trước make)
          make download -j$(nproc)
          # Bắt đầu build
          make -j$(nproc) V=s
          
      - name: 7. Upload Artifacts (Firmware)
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Firmware_RTL9607C_23.05
          path: openwrt/bin/targets/
