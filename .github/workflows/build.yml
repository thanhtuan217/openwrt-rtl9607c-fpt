name: Build OpenWrt RTL9607C (G-97RG6W) WISP Firmware

on:
  # Cho phép chạy thủ công qua giao diện GitHub
  workflow_dispatch:
    inputs:
      ssh_to_image:
        description: 'Enable SSH on the final image'
        required: false
        default: 'false'
      custom_firmware_name:
        description: 'Custom firmware filename (e.g., my_router_fw.bin)'
        required: false
        default: ''

  # Kích hoạt khi có thay đổi trên branch chính (master/main)
  push:
    branches:
      - master
      - main
    paths:
      - '.config'
      - '.github/workflows/build.yml'
      - 'target/**' # Bao gồm các thay đổi về Target Realtek

env:
  TZ: Asia/Ho_Chi_Minh
  # Giữ nguyên tên repo, nhưng bước clone sẽ thay đổi
  REPO_NAME: openwrt-rtl9607c-fpt
  # Tên người dùng và repository để clone
  CUSTOM_REPO_OWNER: thanhtuan217
  CUSTOM_REPO_NAME: openwrt-rtl9607c-fpt

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 1. Checkout Repository Chính (Source Code của bạn)
        # Sử dụng actions/checkout@v4 để clone repository chứa mã nguồn Realtek tùy chỉnh
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CUSTOM_REPO_OWNER }}/${{ env.CUSTOM_REPO_NAME }}
          ref: main # Hoặc tên branch bạn đang làm việc
          path: ${{ env.REPO_NAME }} # Clone vào thư mục tên là openwrt-rtl9607c-fpt
          
      - name: 2. Install dependencies
        run: |
          sudo apt update
          # Các gói cần thiết để build OpenWrt
          sudo apt install -y build-essential diffutils gawk gcc-multilib libelf-dev libncurses5-dev rsync unzip wget git python3 file libssl-dev
          
      # --- Các bước này sẽ chạy trong thư mục đã clone ---
      - name: 3. Update Feeds và Thiết lập Cấu hình
        working-directory: ./${{ env.REPO_NAME }}
        run: |
          # Cập nhật và cài đặt feeds (packages bên ngoài)
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # Đảm bảo file .config hợp lệ và áp dụng các thiết lập
          # make defconfig sẽ áp dụng các thay đổi trong .config lên config kernel
          make defconfig
        
      - name: 4. Download Source Code
        working-directory: ./${{ env.REPO_NAME }}
        # -j$(nproc) sử dụng tất cả lõi CPU để tăng tốc
        run: make download -j$(nproc)

      - name: 5. Build Firmware
        working-directory: ./${{ env.REPO_NAME }}
        # V=s: verbose output (cần cho gỡ lỗi)
        run: make -j$(nproc) V=s

      - name: 6. Prepare Artifacts
        id: prepare_artifacts
        working-directory: ./${{ env.REPO_NAME }}
        run: |
          # Đường dẫn thư mục chứa firmware sau khi build
          # Target RTL9607C nằm dưới realtek/rtl9607c
          FIRMWARE_DIR="./bin/targets/realtek/rtl9607c" 
          ARTIFACT_NAME="OpenWrt-RTL9607C-WISP"
          
          CUSTOM_NAME="${{ github.event.inputs.custom_firmware_name }}"
          if [ -n "$CUSTOM_NAME" ]; then
            ARTIFACT_NAME="$CUSTOM_NAME"
          fi
          
          # Tìm kiếm file firmware factory (ưu tiên G97RG6W)
          FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -type f -name "*g97rg6w*-squashfs-factory.bin" -o -name "*rtl9607c*-squashfs-factory.bin" | head -n 1)

          if [ -z "$FIRMWARE_FILE" ]; then
            echo "Error: Factory firmware file not found in $FIRMWARE_DIR"
            # Nếu không tìm thấy factory, thử tìm sysupgrade
            FIRMWARE_FILE=$(find "$FIRMWARE_DIR" -maxdepth 1 -type f -name "*squashfs-sysupgrade.bin" | head -n 1)
            if [ -z "$FIRMWARE_FILE" ]; then
                echo "Error: No firmware file found."
                exit 1
            fi
          fi

          echo "Found firmware file: $FIRMWARE_FILE"
          echo "firmware_path=$FIRMWARE_FILE" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: 7. Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare_artifacts.outputs.artifact_name }}
          path: ./${{ env.REPO_NAME }}/${{ steps.prepare_artifacts.outputs.firmware_path }}
